{% comment %}
  Facebook Pixel Event Tracking
  Tracks: AddToCart, InitiateCheckout, Purchase
{% endcomment %}

{%- if template.name == 'product' -%}
  {%- comment -%} Track Add to Cart on Product Pages {%- endcomment -%}
  <script>
    (function() {
      if (typeof fbq === 'undefined') return;

      // Get product data from page
      const getProductData = () => {
        const productJson = document.querySelector('[data-product-json], script[type="application/json"][data-product-json]');
        if (productJson) {
          try {
            const product = JSON.parse(productJson.textContent);
            return {
              id: product.id,
              title: product.title,
              price: product.price / 100,
              variant: product.selected_or_first_available_variant?.id
            };
          } catch (e) {
            console.error('Error parsing product JSON:', e);
          }
        }
        return null;
      };

      // Listen for cart updates (Shopify's native event)
      document.addEventListener('DOMContentLoaded', function() {
        // Method 1: Intercept fetch requests to /cart/add.js
        const originalFetch = window.fetch;
        window.fetch = function(...args) {
          const url = args[0];
          if (typeof url === 'string' && url.includes('/cart/add')) {
            const product = getProductData();
            if (product) {
              fbq('track', 'AddToCart', {
                content_name: product.title,
                content_ids: [String(product.id)],
                content_type: 'product',
                value: product.price,
                currency: '{{ cart.currency.iso_code }}'
              });
            }
          }
          return originalFetch.apply(this, args);
        };

        // Method 2: Listen for form submissions
        const forms = document.querySelectorAll('form[action*="/cart/add"]');
        forms.forEach(form => {
          form.addEventListener('submit', function(e) {
            const product = getProductData();
            if (product) {
              fbq('track', 'AddToCart', {
                content_name: product.title,
                content_ids: [String(product.id)],
                content_type: 'product',
                value: product.price,
                currency: '{{ cart.currency.iso_code }}'
              });
            }
          });
        });

        // Method 3: Listen for quick add buttons
        document.addEventListener('click', function(e) {
          const button = e.target.closest('[name="add"], button[type="submit"]');
          if (button && button.form?.action?.includes('/cart/add')) {
            const product = getProductData();
            if (product) {
              setTimeout(() => {
                fbq('track', 'AddToCart', {
                  content_name: product.title,
                  content_ids: [String(product.id)],
                  content_type: 'product',
                  value: product.price,
                  currency: '{{ cart.currency.iso_code }}'
                });
              }, 100);
            }
          }
        });
      });
    })();
  </script>
{%- endif -%}

{%- if template.name == 'cart' -%}
  {%- comment -%} Track Initiate Checkout on Cart Page {%- endcomment -%}
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const checkoutButtons = document.querySelectorAll('button[name="checkout"], a[href*="/checkout"]');
      
      checkoutButtons.forEach(button => {
        button.addEventListener('click', function() {
          if (typeof fbq !== 'undefined') {
            fbq('track', 'InitiateCheckout', {
              content_ids: {{ cart.items | map: 'product_id' | json }},
              content_type: 'product',
              value: {{ cart.total_price | money_without_currency | remove: ',' }},
              currency: '{{ cart.currency.iso_code }}',
              num_items: {{ cart.item_count }}
            });
          }
        });
      });
    });
  </script>
{%- endif -%}

{%- if template.name == 'customers/order' or checkout.order -%}
  {%- comment -%} Track Purchase on Thank You Page {%- endcomment -%}
  {%- if first_time_accessed -%}
    <script>
      if (typeof fbq !== 'undefined') {
        fbq('track', 'Purchase', {
          content_ids: {{ order.line_items | map: 'product_id' | json }},
          content_type: 'product',
          value: {{ order.total_price | money_without_currency | remove: ',' }},
          currency: '{{ order.currency }}',
          num_items: {{ order.line_items.size }}
        });
      }
    </script>
  {%- endif -%}
{%- endif -%}
